#
# Copyright Soramitsu Co., Ltd. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#

add_library(assets
    assets.cpp
    )

add_custom_target(embedded_chainspec)
add_custom_target(embedded_keys)

if(EMBEDDINGS)
    set(SOURCE ${PROJECT_SOURCE_DIR}/examples/first_kagome_chain/localchain.json)
    if(NOT EXISTS ${SOURCE})
        fatal_error("Not found resource for embedded assets: ${SOURCE}")
    endif()
    set(OUTPUT embedded_chainspec.hpp)
    add_custom_command(
        TARGET embedded_chainspec
        PRE_BUILD
        COMMAND echo ARGS "// Embedded chain-spec. Generated by cmake from ${SOURCE}" > ${OUTPUT}
        && echo >> ${OUTPUT}
        && echo "#include <assets/assets.hpp>" >> ${OUTPUT}
        && echo >> ${OUTPUT}
        && echo "namespace kagome::assets {" >> "${OUTPUT}"
        && echo >> ${OUTPUT}
        && echo "  const char *const embedded_chainspec = R\"%chainspec%\(" >> ${OUTPUT}
        && cat ${SOURCE} >> ${OUTPUT}
        && echo "\)%chainspec%\";" >> ${OUTPUT}
        && echo >> ${OUTPUT}
        && echo "}  // namespace kagome::assets" >> ${OUTPUT}
        COMMENT "Generating ${OUTPUT} with embedding chain spec"
        VERBATIM
        )

    set(SOURCE ${PROJECT_SOURCE_DIR}/examples/first_kagome_chain/base_path/dev/keystore)
    if(NOT IS_DIRECTORY ${SOURCE})
        fatal_error("Not found resource for embedded assets: ${SOURCE}")
    endif()
    set(OUTPUT embedded_keys.hpp)
    add_custom_command(
        TARGET embedded_keys
        PRE_BUILD
        COMMAND echo ARGS "// Embedded keys. Generated by cmake from ${SOURCE}" > ${OUTPUT}
        && echo >> ${OUTPUT}
        && echo "#include <assets/assets.hpp>" >> ${OUTPUT}
        && echo "#include <map>" >> ${OUTPUT}
        && echo >> ${OUTPUT}
        && echo "namespace kagome::assets {" >> "${OUTPUT}"
        && echo >> ${OUTPUT}
        && echo "  const std::map<char const *const, char const *const> embedded_keys{" >> ${OUTPUT}
        && sh -c "cd ${SOURCE};\
            for key in * ; do\
             echo -n \"      {\\\"\";\
               echo -n $key;\
             echo \"\\\",\";\
             echo -n \"       \\\"\";\
               cat $key;\
             echo \"\\\"},\";\
            done"
            >> ${OUTPUT}
        && echo "  };" >> ${OUTPUT}
        && echo >> ${OUTPUT}
        && echo "}  // namespace kagome::assets" >> ${OUTPUT}
        COMMENT "Generating ${OUTPUT} with embedding keys"
        VERBATIM
        )

    add_compile_definitions(
        PRIVATE USE_KAGOME_EMBEDDINGS
        )
else()
    set(OUTPUT embedded_chainspec.hpp)
    add_custom_command(
        TARGET embedded_chainspec
        PRE_BUILD
        COMMAND echo ARGS "// Chain-spec was not embed. EMBEDDINGS option is OFF" > ${OUTPUT}
        COMMENT "Generating empty ${OUTPUT}"
    )

    set(OUTPUT embedded_keys.hpp)
    add_custom_command(
        TARGET embedded_keys
        PRE_BUILD
        COMMAND echo ARGS "// Keys was not embed. EMBEDDINGS option is OFF" > ${OUTPUT}
        COMMENT "Generating empty ${OUTPUT}"
    )
endif()

add_dependencies(assets
    embedded_chainspec
    embedded_keys
    )
target_include_directories(assets
    PRIVATE ${CMAKE_CURRENT_BINARY_DIR}
    )
target_sources(assets
    PRIVATE assets.cpp
    )
